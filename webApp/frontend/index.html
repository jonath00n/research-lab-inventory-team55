<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Home</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="icon" href="images/green-logo.png" type="image/png">
</head>

<body>
    <div class="main-content">
        <!-- DASHBOARD -->
        <header class="dashboard">
            <div class="logo">
                <img src="images/texas-am-university-logo-black-and-white.png" alt="Logo">
            </div>
            <nav class="navigation">
                <ul id="auth-buttons">
                    <!-- CART -->
                    <li id="cart-icon-container" style="display: none;">
                        <div class="cart-icon" id="cart-icon">
                            <i class="fas fa-shopping-cart"></i>
                            <span id="cart-count" style="display: none;">0</span>
                        </div>
                    </li>


                    <!-- USER ICON -->
                    <li id="user-icon-container">
                        <div class="user-icon" id="user-icon">
                            <i class="fas fa-user"></i>
                        </div>
                        <div class="dropdown" id="user-dropdown" style="display: none;">
                            <a href="account.html" id="account-option" style="display: none;">Account</a>
                            <a href="sign-in.html" id="sign-in-option">Sign in</a>
                            <a href="register.html" id="register-option">Register</a>
                            <a href="management.html" id="management-option" style="display: none;">Management</a>
                            <a href="faq.html">About</a>
                            <a href="#" id="sign-out-option" style="display: none;">Sign out</a>
                        </div>
                    </li>
                </ul>
            </nav>
        </header>

        <!-- BUBBLE BANNER -->
        <section class="banner">
            <img src="images/background.png" alt="Banner Image" class="banner-image">

            <div class="scrolling-image-container">
                <img src="images/bubbles.png" alt="Scrolling Image" class="scrolling-image">
            </div>

            <div class="overlay-image-container">
                <img src="images/labrat-name.png" alt="Overlay Image" class="overlay-image">
                <p class="overlay-text">Your Lab (re)Search Engine</p>
            </div>
        </section>

        <!-- SEARCH BAR -->
        <section class="search-bar-container" style="display: none;">
            <input type="text" class="search-bar" placeholder="âŒ• Search">
        </section>

        <!-- INFO & FAQ -->
        <section class="information">
            <div class="info-text">
                <h2>What is LabRat?</h2>
                <p>LabRat is your research laboratory database management destination.
                    LabRat revolutionizes the way laboratories manage their inventory by
                    offering a cutting-edge search engine with advanced filtering capabilities
                    to streamline the organization of your essential supplies and equipment. With
                    its intuitive interface, LabRat simplifies the tracking of inventory
                    and empowers researchers to optimize their workflow, and guarantees that they
                    have the right tools at their fingertips when they need them. Experience
                    unparalleled efficiency and precision in inventory management, as LabRat
                    transforms your laboratory into a beacon of innovation and productivity.
                    For more information, see our <a href="faq.html">FAQs</a>.</p>
            </div>
            <div class="info-image">
                <img src="images/new-labrat-glass.png" alt="LabRat Information Image">
            </div>
        </section>
    </div>

    <!-- CART MODAL -->
    <div id="cart-modal" class="cart-modal">
        <div class="cart-modal-content">
            <span class="close-cart">&times;</span>
            <h2 class="cart-title">Your Cart</h2>
            <div class="cart-items" id="cart-items">
                <!-- List of items in cart will go here -->
            </div>
        </div>
        <div id="returnable-agreement" style="display: none; margin-top: 20px;">
            <input type="checkbox" id="returnable-checkbox">
            <label for="returnable-checkbox" id="returnable-agreement-label">
                <!-- The agreement text will be set dynamically if there are returnable items -->
            </label>
        </div>
        <button id="checkout-button" style="display: none; margin-top: 20px;">Checkout</button>
    </div>

    <script>            
        // Fetch the current logged-in user
        async function fetchCurrentUser() {
            try {
                const response = await fetch('/current-user');
                if (!response.ok) throw new Error('Failed to fetch user');
            
                const data = await response.json();
                console.log("User data:", data);
            
                if (data.user) {
                    const { name, email, color, permission } = data.user;
                    document.getElementById('user-icon').textContent = name.charAt(0).toUpperCase();
                    document.getElementById('user-icon').style.backgroundColor = color;
                
                    document.getElementById('sign-in-option').style.display = 'none';
                    document.getElementById('register-option').style.display = 'none';
                    document.getElementById('account-option').style.display = 'block';
                    document.getElementById('sign-out-option').style.display = 'block';
                
                    // Show management option for admin users
                    if (permission === 'professor' || permission === 'admin') {
                        document.getElementById('management-option').style.display = 'block';
                    }
                
                    document.getElementById('cart-icon-container').style.display = 'block';
                
                    // Show search bar
                    document.querySelector('.search-bar-container').style.display = 'block';
                
                    // Hide the information section
                    const infoSection = document.querySelector('.information');
                    if (infoSection) {
                        infoSection.style.display = 'none';
                    }
                
                    // Fetch cart items from DB
                    await loadCartItems();
                    fetchItems();
                }
            } catch (error) {
                console.error("Error fetching user:", error);
            }
        }

        // Store for items fetched
        let allItems = [];

        // Fetch all items in the items table
        async function fetchItems() {
            try {
                const response = await fetch('/items');
                if (!response.ok) throw new Error("Failed to fetch items");
        
                const data = await response.json();
        
                allItems = data.items;
        
                renderTable(allItems);
                enableSearchFilter(); 
            } catch (error) {
                console.error("Error fetching items:", error);
            }
        }        

        // Render the table based on the provided items
        function renderTable(items) {
            const existingTable = document.querySelector('.items-table');
            if (existingTable) existingTable.remove();
        
            // Create the table
            const table = document.createElement('table');
            table.classList.add('items-table');
        
            // Table Header with Filter Dropdowns
            const thead = document.createElement('thead');
            thead.innerHTML = `
                <button id="reset-filters-btn" style="padding: 5px 10px; border: 1px solid #ccc; background-color: #f8f8f8; cursor: pointer;">
                    Reset Filters
                </button>
                <tr>
                    <th>
                        Name 
                    </th>
                    <th>
                        <select id="category-filter">
                            <option value="all">Category</option>
                        </select>
                    </th>
                    <th>
                        <select id="unit-filter">
                            <option value="all">Unit</option>
                        </select>
                    </th>
                    <th>
                        <select id="location-filter">
                            <option value="all">Location</option>
                        </select>
                    </th>
                    <th>
                        <select id="supplier-filter">
                            <option value="all">Supplier</option>
                        </select>
                    </th>
                    <th>Quantity</th>
                    <th>Add to Cart</th>
                </tr>
            `;
            table.appendChild(thead);
        
            // Table Body
            const tbody = document.createElement('tbody');
            items.forEach(item => {
        
                if (!item.id || isNaN(item.id)) {
                    console.error("Invalid item ID detected:", item);
                    return;
                }
        
                const row = document.createElement('tr');
        
                if (item.quantity < 1) {
                    row.classList.add('disabled-row');
                    row.innerHTML = `
                        <td>${item.name}</td>
                        <td>${item.categoryID}</td>
                        <td>${item.unit}</td>
                        <td>${item.location}</td>
                        <td>${item.supplier}</td>
                        <td>${item.quantity}</td>
                        <td>
                            <input type="number" class="quantity-input" value="0" disabled style="width: 60px;"/>
                            <button class="add-to-cart-btn" disabled>Add to Cart</button>
                        </td>
                    `;
                } else {
                    row.innerHTML = `
                        <td>${item.name}</td>
                        <td>${item.categoryID}</td>
                        <td>${item.unit}</td>
                        <td>${item.location}</td>
                        <td>${item.supplier}</td>
                        <td>${item.quantity}</td>
                        <td>
                            <input type="number" class="quantity-input" value="1" min="1" max="${item.quantity}" style="width: 60px;" 
                                oninput="if(this.value > ${item.quantity}) this.value = ${item.quantity};"/>
                            <button class="add-to-cart-btn" data-item-id="${item.id}">Add to Cart</button>
                        </td>
                    `;
                }
        
                tbody.appendChild(row);
            });
        
            table.appendChild(tbody);
            document.querySelector('.main-content').appendChild(table);
        
            // Populate and Enable Filters
            populateFilterOptions(items);
            enableTableFilters();
        
            // Attach event listeners to all "Add to Cart" buttons
            document.querySelectorAll('.add-to-cart-btn:not([disabled])').forEach(button => {
                button.addEventListener('click', async function () {
                    const itemId = this.getAttribute('data-item-id');
                    const quantityInput = this.previousElementSibling;
                    let quantity = quantityInput.value.trim();
                
                    if (!quantity || isNaN(quantity) || quantity <= 0) {
                        console.error("Invalid quantity input:", quantity);
                        return;
                    }
        
                    await addToCart(itemId, quantity);
                });
            });
        }

        // Reset filters button
        function resetFilters() {
            document.getElementById('category-filter').value = "all";
            document.getElementById('unit-filter').value = "all";
            document.getElementById('location-filter').value = "all";
            document.getElementById('supplier-filter').value = "all";
        
            renderTable(allItems);
        }

        // Go through database and give options for select element
        function populateFilterOptions(items) {
            const categoryFilter = document.getElementById('category-filter');
            const unitFilter = document.getElementById('unit-filter');
            const locationFilter = document.getElementById('location-filter');
            const supplierFilter = document.getElementById('supplier-filter');
        
            const uniqueCategories = new Set();
            const uniqueUnits = new Set();
            const uniqueLocations = new Set();
            const uniqueSuppliers = new Set();
        
            items.forEach(item => {
                uniqueCategories.add(item.categoryID);
                uniqueUnits.add(item.unit);
                uniqueLocations.add(item.location);
                uniqueSuppliers.add(item.supplier);
            });
        
            addOptionsToDropdown(categoryFilter, uniqueCategories);
            addOptionsToDropdown(unitFilter, uniqueUnits);
            addOptionsToDropdown(locationFilter, uniqueLocations);
            addOptionsToDropdown(supplierFilter, uniqueSuppliers);
        }
        
        // Add above filter options
        function addOptionsToDropdown(dropdown, optionsSet) {
            optionsSet.forEach(option => {
                const optionElement = document.createElement('option');
                optionElement.value = option;
                optionElement.textContent = option;
                dropdown.appendChild(optionElement);
            });
        }    
        
        // Even listeners for filters
        function enableTableFilters() {
            document.getElementById('category-filter').addEventListener('change', filterTable);
            document.getElementById('unit-filter').addEventListener('change', filterTable);
            document.getElementById('location-filter').addEventListener('change', filterTable);
            document.getElementById('supplier-filter').addEventListener('change', filterTable);
            document.getElementById('reset-filters-btn').addEventListener('click', resetFilters);
        }
        
        // Actually filtering the table
        function filterTable() {
            const selectedCategory = document.getElementById('category-filter').value;
            const selectedUnit = document.getElementById('unit-filter').value;
            const selectedLocation = document.getElementById('location-filter').value;
            const selectedSupplier = document.getElementById('supplier-filter').value;
        
            const filteredItems = allItems.filter(item => {
                return (selectedCategory === "all" || item.categoryID === selectedCategory) &&
                       (selectedUnit === "all" || item.unit === selectedUnit) &&
                       (selectedLocation === "all" || item.location === selectedLocation) &&
                       (selectedSupplier === "all" || item.supplier === selectedSupplier);
            });
        
            renderTable(filteredItems);
        }        

        // Enable search filter functionality
        function enableSearchFilter() {
            const searchBar = document.querySelector('.search-bar');
            
            if (!searchBar) return;
        
            searchBar.addEventListener('input', function () {
                filterItems();
            });
        }

        // Enable dropdown filter functionality
        function enableDropdownFilters() {
            document.querySelectorAll('.filter select').forEach(select => {
                select.addEventListener('change', function () {
                    filterItems();
                });
            });
        }

        // Filter items based on search input and dropdown selections
        function filterItems() {
            const searchValue = document.querySelector('.search-bar').value.toLowerCase();
            const selectedCategory = document.getElementById('category-filter').value;
            const selectedUnit = document.getElementById('unit-filter').value;
            const selectedLocation = document.getElementById('location-filter').value;
            const selectedSupplier = document.getElementById('supplier-filter').value;
        
            const filteredItems = allItems.filter(item => {
                // Check if the item name matches the search query
                const matchesSearch = item.name.toLowerCase().includes(searchValue);
        
                // Check if the item matches the selected filters
                const matchesCategory = selectedCategory === "all" || item.categoryID === selectedCategory;
                const matchesUnit = selectedUnit === "all" || item.unit === selectedUnit;
                const matchesLocation = selectedLocation === "all" || item.location === selectedLocation;
                const matchesSupplier = selectedSupplier === "all" || item.supplier === selectedSupplier;
        
                return matchesSearch && matchesCategory && matchesUnit && matchesLocation && matchesSupplier;
            });
        
            renderTable(filteredItems);
        }        

        // Add the selected item to the user's cart
        async function addToCart(itemId, quantity) {
            if (!itemId || itemId === "0" || itemId === "" || itemId === null) {
                console.error("Invalid item ID. Cannot add to cart.");
                return;
            }
        
            quantity = parseInt(quantity);
        
            if (isNaN(quantity) || quantity <= 0) {
                console.error("Invalid quantity detected:", quantity);
                return;
            }
                
            try {
                const response = await fetch('/add-to-cart', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ item_id: parseInt(itemId), quantity: quantity })
                });
        
                if (!response.ok) throw new Error('Error adding item to cart');
        
                loadCartItems();
            } catch (error) {
                console.error('Error:', error);
            }
        }       
        
        // Remove the selected item from user's cart
        async function removeFromCart(itemId) {
            try {
                const response = await fetch('/remove-from-cart', {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ item_id: itemId })
                });
        
                if (!response.ok) throw new Error('Failed to remove item');
        
                console.log("Item removed successfully");
                await loadCartItems(); 
            } catch (error) {
                console.error("Error:", error);
            }
        }              

        // Update the cart in the database
        async function updateCart(cart) {
            try {
                const response = await fetch('/update-cart', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ cart: JSON.stringify(cart) })
                });

                if (!response.ok) {
                    throw new Error('Error updating cart');
                }
            } catch (error) {
                console.error('Error updating cart:', error);
            }
        }

        // Sign-out functionality
        async function signOutUser() {
            try {
                const response = await fetch('/sign-out', { method: 'POST' });
                if (response.ok) {
                    window.location.href = 'index.html';
                } else {
                    alert("Error signing out.");
                }
            } catch (error) {
                console.error('Error signing out:', error);
            }
        }

        // Set up sign-out option click event
        document.getElementById('sign-out-option').addEventListener('click', signOutUser);

        // Set up click event to toggle the dropdown visibility
        document.getElementById('user-icon').addEventListener('click', function () {
            const dropdown = document.getElementById('user-dropdown');
            dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none';
        });

        // Hide dropdown when clicking outside of it
        document.addEventListener('click', function (event) {
            const dropdown = document.getElementById('user-dropdown');
            const userIcon = document.getElementById('user-icon');

            if (!dropdown.contains(event.target) && !userIcon.contains(event.target)) {
                dropdown.style.display = 'none';
            }
        });

        // Function to open the cart modal
        function openCartModal() {
            document.getElementById('cart-modal').classList.add('open');
            document.querySelector('.main-content').classList.add('modal-blur');
            document.body.classList.add('modal-open');
        }

        // Function to close the cart modal
        function closeCartModal() {
            document.getElementById('cart-modal').classList.remove('open');
            document.querySelector('.main-content').classList.remove('modal-blur');
            document.body.classList.remove('modal-open');
        }

        async function loadCartItems() {
            try {
                const response = await fetch('/cart');
                let cartItems = await response.json();
        
                if (!Array.isArray(cartItems)) {
                    console.error("Invalid cart data:", cartItems);
                    cartItems = [];
                }
                
                const cartItemsContainer = document.getElementById('cart-items');
                const checkoutButton = document.getElementById('checkout-button');
                const returnableAgreement = document.getElementById('returnable-agreement');
                const returnableCheckbox = document.getElementById('returnable-checkbox');
                const returnableLabel = document.getElementById('returnable-agreement-label');
                const cartCount = document.getElementById('cart-count');
        
                cartItemsContainer.innerHTML = '';
        
                if (cartItems.length === 0) {
                    cartItemsContainer.innerHTML = '<p>Your cart is empty.</p>';
                    checkoutButton.style.display = 'none';
                    returnableAgreement.style.display = 'none';
                    cartCount.textContent = "0";
                    cartCount.style.display = "block";
                    return;
                }
        
                let hasReturnableItems = false;
                let totalCartQuantity = 0;
        
                for (const { item_id, item_name, quantity, returnable } of cartItems) {
                    const stock_quantity = await getItemStock(item_id);
                
                    totalCartQuantity += quantity;
                
                    const itemElement = document.createElement('div');
                    itemElement.classList.add('cart-item');
                
                    const nameElement = document.createElement('span');
                    nameElement.classList.add('cart-item-name');
                    nameElement.textContent = item_name;
                
                    const quantityInput = document.createElement('input');
                    quantityInput.type = 'number';
                    quantityInput.value = quantity;
                    quantityInput.min = 1;
                    quantityInput.max = stock_quantity;
                    quantityInput.classList.add('quantity-input');
                    quantityInput.style.width = '60px';
                    quantityInput.addEventListener('change', function () {
                        let newQuantity = parseInt(this.value);
                        if (newQuantity < 1) {
                            removeFromCart(item_id);
                        } else if (newQuantity > stock_quantity) {
                            this.value = stock_quantity;
                        } else {
                            updateQuantity(item_id, newQuantity);
                        }
                    });
                
                    const removeButton = document.createElement('i');
                    removeButton.classList.add('fas', 'fa-trash', 'remove-cart-item');
                    removeButton.onclick = () => removeFromCart(item_id);
                
                    itemElement.appendChild(nameElement);
                    itemElement.appendChild(quantityInput);
                    itemElement.appendChild(removeButton);
                    cartItemsContainer.appendChild(itemElement);
                
                    if (returnable) hasReturnableItems = true;
                }
                
        
                // Update the cart icon with total quantity
                if (cartItems.length === 0 || totalCartQuantity < 1) {
                    cartCount.textContent = "0";
                    cartCount.style.display = "block"; 
                } else {
                    cartCount.textContent = totalCartQuantity;
                    cartCount.style.display = 'block';
                }
                

                // Display the returnable checkbox if any items are returnable
                if (hasReturnableItems) {
                    returnableAgreement.style.display = 'block';
                    returnableLabel.innerText = "I hereby acknowledge that I am responsible for returning the borrowed items in good condition, and any damages to borrowed items will require compensation from me. Failure to do so may additionally result in penalties or restricted access to LabRat's services.";
                    returnableCheckbox.checked = false;
                    checkoutButton.style.display = 'none'; 
        
                    // Enable checkout when checkbox is checked
                    returnableCheckbox.addEventListener('change', function () {
                        checkoutButton.style.display = this.checked ? 'block' : 'none';
                    });
                } else {
                    returnableAgreement.style.display = 'none';
                    checkoutButton.style.display = 'block';
                }
        
            } catch (error) {
                console.error("Error loading cart:", error);
            }
        }

        async function getItemStock(itemId) {
            try {
                const response = await fetch('/items');
                const data = await response.json();
                const match = data.items.find(item => item.id == itemId);
                return match ? match.quantity : 0;
            } catch (error) {
                console.error("Failed to fetch item stock:", error);
                return 0;
            }
        }
        

        // Update quantity when changed in cart modal
        async function updateQuantity(itemId, newQuantity) {
            if (newQuantity < 1) {
                await removeFromCart(itemId);
                await loadCartItems();  
                return;
            }
            
        
            try {
                const response = await fetch('/update-cart', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ item_id: itemId, quantity: newQuantity })
                });
        
                if (!response.ok) throw new Error('Failed to update cart');
        
                await loadCartItems();
            } catch (error) {
                console.error("Error updating cart:", error);
            }
        }
        

        // Function to place the order, adjust item quantities, and clear the cart
        async function checkout() {
            try {
                const response = await fetch('/current-user');
                if (!response.ok) throw new Error("Failed to get user data");
        
                const data = await response.json();
                const userName = data.user.name;
                const userEmail = data.user.email;
        
                const cartResponse = await fetch('/cart');
                const cartItems = await cartResponse.json();
        
                if (!Array.isArray(cartItems) || cartItems.length === 0) {
                    console.error("Cart is empty.");
                    return;
                }
        
                for (const { item_id, item_name, returnable, quantity } of cartItems) {
                    if (!item_name) {
                        console.error("Missing item_name for item_id:", item_id);
                        continue; 
                    }
        
                    console.log(`Processing Order: ${item_name} (ID: ${item_id}) - Quantity: ${quantity}`);
        
                    // Push to orders table
                    await fetch('/add-order', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            user_name: userName,
                            user_email: userEmail,
                            item_id,
                            item_name,
                            returnable,
                            quantity
                        })
                    });
        
                    // If returnable, push to returns table
                    if (returnable) {
                        await fetch('/add-return', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                email: userEmail,
                                item_id,
                                item_name, 
                                quantity
                            })
                        });
                    }
        
                    // Update item stock
                    await fetch(`/update-item-quantity/${item_id}`, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ quantity: -quantity })
                    });
                }
        
                // Clear cart
                await fetch('/clear-cart', { method: 'DELETE' });
        
                closeCartModal();
                loadCartItems();
                fetchItems();
            } catch (error) {
                console.error("Error during checkout:", error);
            }
        }
        
        

        // Event listener for agreement
        document.getElementById('returnable-checkbox').addEventListener('change', function () {
            const checkoutButton = document.getElementById('checkout-button');
            if (this.checked) {
                checkoutButton.style.display = 'block';
            } else {
                checkoutButton.style.display = 'none';
            }
        });        

        // Event listener to the checkout button
        document.getElementById('checkout-button').addEventListener('click', function () {
            checkout();
        });

        // Event listener to the cart button
        document.getElementById('cart-icon').addEventListener('click', function () {
            openCartModal();
            loadCartItems();
        });

        // Clicking X in cart
        document.querySelector('.close-cart').addEventListener('click', closeCartModal);

        // Search bar event listener
        document.querySelector('.search-bar').addEventListener('input', filterItems);


        // Clicking outside of cart
        document.addEventListener('click', function (event) {
            const cartModal = document.getElementById('cart-modal');
            const cartIcon = document.getElementById('cart-icon');

            if (cartModal.classList.contains('open') && !cartModal.contains(event.target) && !cartIcon.contains(event.target)) {
                closeCartModal();
            }
        });

        window.onload = fetchCurrentUser;
    </script>

</body>

</html>